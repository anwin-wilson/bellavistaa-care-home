<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bellavista Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../../assets/css/styles.css">
  <link rel="stylesheet" href="../../assets/css/dashboard.css">
  <style>
    :root{
      --primary-blue:#0066cc;--primary-teal:#00b4d8;--primary-purple:#7209b7;--primary-pink:#f72585;--primary-orange:#ff9500;--primary-green:#06ffa5;--bg-1:#f8f9fa;--bg-2:#e9ecef;--ink:#212529;--muted:#6c757d;--white:#fff;--shadow:0 10px 30px rgba(0,0,0,.08);--grad:linear-gradient(135deg,#0066cc,#00b4d8)
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Lato',sans-serif;background:var(--bg-1);color:var(--ink);min-height:100dvh}
    /* Layout */
    .app{display:grid;grid-template-columns:260px 1fr;grid-template-rows:64px 1fr;grid-template-areas:"sidebar header" "sidebar main";min-height:100dvh}
    header{grid-area:header;background:linear-gradient(90deg,var(--white),#f0f8ff);box-shadow:0 2px 15px rgba(0,0,0,.06);display:flex;align-items:center;justify-content:space-between;padding:0 18px;position:sticky;top:0;z-index:10}
    .brand{display:flex;gap:10px;align-items:center}
    .brand i{font-size:26px;background:linear-gradient(45deg,var(--primary-blue),var(--primary-teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .brand h1{font-family:'Playfair Display',serif;font-size:20px}
    .admin-badge{font-size:12px;color:var(--white);background:var(--primary-purple);padding:4px 10px;border-radius:999px}
    .header-actions{display:flex;gap:8px;align-items:center}
    .btn{border:none;background:var(--grad);color:var(--white);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 6px 16px rgba(0,102,204,.25);transition:.2s}
    .btn:hover{transform:translateY(-1px)}
    .btn.ghost{background:transparent;color:var(--primary-blue);border:2px solid #cfe8ff;box-shadow:none}
    .btn.warn{background:linear-gradient(135deg,#ef4444,#f97316)}
    .btn.success{background:linear-gradient(135deg,#10b981,#06b6d4)}
    .btn.small{padding:6px 10px;border-radius:8px;font-size:12px}

    aside{grid-area:sidebar;background:linear-gradient(180deg,var(--white),#f6fbff);border-right:1px solid #e8eef5;box-shadow:2px 0 12px rgba(0,0,0,.04);padding:14px;position:sticky;top:0;height:100dvh;overflow-y:auto}
    .search{display:flex;gap:8px;background:#fff;border:1.5px solid #e6eef7;border-radius:12px;padding:8px 10px;margin:6px 0 12px}
    .search input{border:none;outline:none;width:100%}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .nav button{all:unset;display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:10px;color:#334155;cursor:pointer;transition:.15s}
    .nav button i{width:18px;text-align:center}
    .nav button.active,.nav button:hover{background:linear-gradient(90deg,rgba(0,102,204,.08),rgba(0,180,216,.06));color:var(--primary-blue)}
    .nav .group-title{font-size:11px;color:#8aa0b5;text-transform:uppercase;letter-spacing:.08em;margin:10px 10px 4px}

    main{grid-area:main;padding:22px;}
    .panel{background:#fff;border:1px solid #e8eef5;border-radius:16px;box-shadow:var(--shadow);padding:18px;}
    .panel h2{font-family:'Playfair Display',serif;font-size:22px;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
    .muted{color:var(--muted);font-size:14px}

    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.responsive{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}

    label{font-weight:700;font-size:13px;color:#334155}
    input[type="text"], input[type="url"], input[type="date"], input[type="email"], select, textarea{width:100%;padding:12px 12px;border:1.5px solid #e6eef7;border-radius:12px;font:inherit;outline:none;transition:.15s;background:#fff}
    textarea{min-height:110px;resize:vertical}
    input:focus, textarea:focus, select:focus{box-shadow:0 0 0 4px rgba(0,102,204,.12);border-color:#cde3fb}

    .field{display:grid;gap:6px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .right{margin-left:auto}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{text-align:left;font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.06em;padding:4px 10px}
    tbody tr{background:#fff;border:1px solid #e6eef7}
    tbody td{padding:12px 10px;vertical-align:top;border-top:1px solid #e6eef7;border-bottom:1px solid #e6eef7}
    tbody tr{border-radius:12px;overflow:hidden}

    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #e6eef7;color:#0f172a}
    .tag.success{background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.2)}
    .tag.warn{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.25)}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 14px}

    .empty{border:1.5px dashed #e6eef7;border-radius:16px;padding:24px;text-align:center;color:#8aa0b5}

    /* Drawer / Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:50;padding:20px}
    .modal.active{display:grid}
    .modal .card{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px;max-width:720px;width:100%;border:1px solid #e6eef7}

    /* Toast */
    .toast{position:fixed;right:18px;bottom:18px;background:#0f172a;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(12px);transition:.25s;z-index:60}
    .toast.show{opacity:1;transform:none}

    /* Responsive */
    @media (max-width:900px){
      .app{grid-template-columns:1fr;grid-template-rows:64px auto 1fr;grid-template-areas:"header" "sidebar" "main"}
      aside{position:static;height:auto}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand"><i class="fa-solid fa-hospital-user"></i><h1>Bellavista Admin</h1><span class="admin-badge">Dashboard</span></div>
    <div class="header-actions">
      <button class="btn warn" id="btnReset"><i class="fa-solid fa-rotate"></i>&nbsp;Reset Demo Data</button>
      <button class="btn" onclick="logout()"><i class="fa-solid fa-sign-out-alt"></i>&nbsp;Logout</button>
    </div>
  </header>

  <aside>
    <div class="search"><i class="fa-solid fa-magnifying-glass"></i><input id="globalSearch" placeholder="Quick search…"/></div>
    <div class="nav">
      <div class="group-title">Homes</div>
      <button data-view="add-home" class="active"><i class="fa-solid fa-house-medical"></i><span>Add Home</span></button>
      <button data-view="update-home"><i class="fa-solid fa-pen-to-square"></i><span>Update Home</span></button>
      <div class="group-title">News</div>
      <button data-view="add-news"><i class="fa-solid fa-newspaper"></i><span>Add News</span></button>
      <button data-view="update-news"><i class="fa-solid fa-rectangle-list"></i><span>Update News</span></button>
      <div class="group-title">Content</div>
      <button data-view="manage-faqs"><i class="fa-solid fa-circle-question"></i><span>Manage FAQs</span></button>
      <div class="group-title">Users</div>
      <button data-view="manage-users"><i class="fa-solid fa-users-gear"></i><span>Manage Users</span></button>
      <div class="group-title">Enquiries</div>
      <button data-view="schedule-tours"><i class="fa-solid fa-calendar-check"></i><span>Schedule Tours</span></button>
      <button data-view="care-enquiries"><i class="fa-solid fa-heart"></i><span>Care Enquiries</span></button>
      <button data-view="career-applications"><i class="fa-solid fa-briefcase"></i><span>Career Applications</span></button>
    </div>
  </aside>

  <main>
    <!-- Add Home -->
    <section class="panel" data-section="add-home">
      <h2>Add Home</h2>
      <p class="muted">Create a new Nursing Home card for the website.</p>
      <div class="grid cols-2">
        <div class="field"><label>Name</label><input id="homeName" type="text" placeholder="e.g., Bellavista Cardiff"/></div>
        <div class="field"><label>Location</label><input id="homeLocation" type="text" placeholder="City, Region"/></div>
        <div class="field"><label>Image</label>
          <div style="display:flex;gap:10px;align-items:center">
            <input id="homeImage" type="url" placeholder="https://…" style="flex:1"/>
            <span>or</span>
            <label for="homeImageFile" class="btn ghost" style="cursor:pointer;margin:0"><i class="fa-solid fa-plus"></i> Upload</label>
            <input id="homeImageFile" type="file" accept="image/*" hidden>
          </div>
        </div>
        <div class="field"><label>Badge</label><select id="homeBadge"><option value="">None</option><option>Featured</option><option>New</option><option>Awarded</option></select></div>
        <div class="field" style="grid-column:1/-1"><label>Description</label><textarea id="homeDesc" placeholder="Short teaser shown on the card…"></textarea></div>
      </div>
      <div class="toolbar"><label style="display:flex;align-items:center;gap:8px"><input id="homeFeatured" type="checkbox"> Featured</label>
        <div class="right"></div>
        <button class="btn" id="btnAddHome"><i class="fa-solid fa-plus"></i>&nbsp;Add Home</button>
      </div>
    </section>

    <!-- Update Home -->
    <section class="panel" data-section="update-home" hidden>
      <h2>Update Home</h2>
      <div class="toolbar">
        <input id="homeSearch" placeholder="Search homes…" style="flex:1" />
        <button class="btn ghost small" id="btnNewHome"><i class="fa-solid fa-plus"></i>&nbsp;New</button>
      </div>
      <div id="homesTableWrap"></div>
    </section>

    <!-- Add News -->
    <section class="panel" data-section="add-news" hidden>
      <h2>Add News</h2>
      <p class="muted">Publish a news item for the “Latest News & Updates” section.</p>
      <div class="grid cols-2">
        <div class="field"><label>Title</label><input id="newsTitle" type="text" placeholder="Headline"/></div>
        <div class="field"><label>Date</label><input id="newsDate" type="date"/></div>
        <div class="field"><label>Category</label>
          <select id="newsCategory"><option>All News</option><option>Health Updates</option><option>Awards</option><option>Events</option><option>Innovation</option><option>Community</option></select>
        </div>
        <div class="field"><label>Image</label>
          <div style="display:flex;gap:10px;align-items:center">
            <input id="newsImage" type="url" placeholder="https://…" style="flex:1"/>
            <span>or</span>
            <label for="newsImageFile" class="btn ghost" style="cursor:pointer;margin:0"><i class="fa-solid fa-plus"></i> Upload</label>
            <input id="newsImageFile" type="file" accept="image/*" hidden>
          </div>
        </div>
        <div class="field" style="grid-column:1/-1"><label>Summary</label><textarea id="newsSummary" placeholder="Short summary shown on the card…"></textarea></div>
        <div class="field" style="grid-column:1/-1"><label>Body (optional)</label><textarea id="newsBody" placeholder="Full article body (for detail page)"></textarea></div>
      </div>
      <div class="toolbar"><div class="right"></div><button class="btn" id="btnAddNews"><i class="fa-solid fa-paper-plane"></i>&nbsp;Publish</button></div>
    </section>

    <!-- Update News -->
    <section class="panel" data-section="update-news" hidden>
      <h2>Update News</h2>
      <div class="toolbar">
        <input id="newsSearch" placeholder="Search news…" style="flex:1" />
      </div>
      <div id="newsTableWrap"></div>
    </section>

    <!-- Manage FAQs -->
    <section class="panel" data-section="manage-faqs" hidden>
      <h2>Manage FAQs</h2>
      <div class="grid cols-2">
        <div class="field"><label>Question</label><input id="faqQ" type="text" placeholder="What types of care do you provide?"/></div>
        <div class="field"><label>Category</label><input id="faqCat" type="text" placeholder="Care, Costs, Visiting…"/></div>
        <div class="field" style="grid-column:1/-1"><label>Answer</label><textarea id="faqA" placeholder="We provide residential, nursing, dementia, respite, and palliative care…"></textarea></div>
      </div>
      <div class="toolbar"><div class="right"></div><button class="btn" id="btnAddFaq"><i class="fa-solid fa-plus"></i>&nbsp;Add FAQ</button></div>
      <div class="toolbar"><input id="faqSearch" placeholder="Search FAQs…" style="flex:1" /></div>
      <div id="faqTableWrap"></div>
    </section>

    <!-- Schedule Tours -->
    <section class="panel" data-section="schedule-tours" hidden>
      <h2>Schedule Tours</h2>
      <div class="toolbar">
        <input id="tourSearch" placeholder="Search tours..." style="flex:1" />
        <select id="tourFilter" style="margin-left: 10px;">
          <option value="">All Locations</option>
          <option value="cardiff">Cardiff</option>
          <option value="barry">Barry</option>
          <option value="waverley">Waverley</option>
          <option value="college-fields">College Fields</option>
        </select>
      </div>
      <div id="toursTableWrap"></div>
    </section>

    <!-- Care Enquiries -->
    <section class="panel" data-section="care-enquiries" hidden>
      <h2>Care Enquiries</h2>
      <div class="toolbar">
        <input id="enquirySearch" placeholder="Search enquiries..." style="flex:1" />
        <select id="enquiryFilter" style="margin-left: 10px;">
          <option value="">All Enquiries</option>
          <option value="immediate">Immediate</option>
          <option value="soon">Soon</option>
          <option value="planning">Planning</option>
        </select>
        <select id="enquiryLocationFilter" style="margin-left: 10px;">
          <option value="">All Locations</option>
          <option value="cardiff">Cardiff</option>
          <option value="barry">Barry</option>
          <option value="waverley">Waverley</option>
          <option value="college-fields">College Fields</option>
        </select>
      </div>
      <div id="enquiriesTableWrap"></div>
    </section>

    <!-- Career Applications -->
    <section class="panel" data-section="career-applications" hidden>
      <h2>Career Applications</h2>
      <div class="toolbar">
        <input id="careerSearch" placeholder="Search applications..." style="flex:1" />
        <select id="careerFilter" style="margin-left: 10px;">
          <option value="">All Positions</option>
          <option value="Nursing Position">Nursing</option>
          <option value="Administrative Role">Administrative</option>
          <option value="Kitchen & Catering Position">Kitchen & Catering</option>
          <option value="Maintenance & Facilities Role">Maintenance</option>
          <option value="Activities & Therapy Position">Activities & Therapy</option>
          <option value="Volunteer Opportunity">Volunteer</option>
        </select>
      </div>
      <div id="careerTableWrap"></div>
    </section>

    <!-- Manage Users -->
    <section class="panel" data-section="manage-users" hidden>
      <h2>Manage Users</h2>
      <div class="grid cols-3">
        <div class="field"><label>Full Name</label><input id="userName" type="text" placeholder="Jane Doe"/></div>
        <div class="field"><label>Email</label><input id="userEmail" type="email" placeholder="jane@bellavista.co.uk"/></div>
        <div class="field"><label>Role</label><select id="userRole"><option>Admin</option><option>Editor</option><option>Viewer</option></select></div>
      </div>
      <div class="toolbar"><div class="right"></div><button class="btn" id="btnAddUser"><i class="fa-solid fa-user-plus"></i>&nbsp;Add User</button></div>
      <div class="toolbar"><input id="userSearch" placeholder="Search users…" style="flex:1" /></div>
      <div id="usersTableWrap"></div>
    </section>
  </main>
</div>

<!-- Modal for editing -->
<div class="modal" id="editModal">
  <div class="card">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <strong id="editTitle">Edit</strong>
      <button class="btn ghost small" id="closeModal"><i class="fa-solid fa-xmark"></i>&nbsp;Close</button>
    </div>
    <div id="editBody"></div>
    <div class="row" style="margin-top:12px;justify-content:flex-end;gap:8px">
      <button class="btn ghost" id="cancelEdit">Cancel</button>
      <button class="btn success" id="saveEdit">Save changes</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="../../assets/js/main.js"></script>
<script src="../../assets/js/main.js"></script>
<script>
// ---------- Utilities ----------
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const uid = () => Math.random().toString(36).slice(2,10);
const showToast = (msg) => { const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2100); };
const confirmBox = (msg) => confirm(msg);

// ---------- Storage Layer (localStorage demo) ----------
const KEY = 'bv-admin-v1';
const emptyState = { homes: [], news: [], faqs: [], users: [] };
const load = () => JSON.parse(localStorage.getItem(KEY) || 'null') || seed();
const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));

function seed(){
  const seeded = {
    homes:[
      {id:uid(), name:'Bellavista Cardiff', location:'Cardiff, South Wales', image:'https://picsum.photos/seed/cardiff/600/400.jpg', badge:'Featured', desc:'A homely and friendly purpose built Nursing Home overlooking Cardiff Bay.', featured:true},
      {id:uid(), name:'Bellavista Barry', location:'Barry, Vale of Glamorgan', image:'https://picsum.photos/seed/barry/600/400.jpg', badge:'New', desc:'Quality Nursing home in the seaside town of Barry with spectacular views.', featured:false}
    ],
    news:[
      {id:uid(), title:'New Activities Programme Launched', date:'2023-10-15', category:'Activities', image:'https://picsum.photos/seed/activities/600/400.jpg', summary:'Engaging residents in meaningful and enjoyable experiences.', body:''},
      {id:uid(), title:'Excellence in Care Award', date:'2023-10-05', category:'Award', image:'https://picsum.photos/seed/award/600/400.jpg', summary:'Bellavista Cardiff has received the Excellence in Care Award.', body:''}
    ],
    faqs:[
      {id:uid(), q:'What types of care do you provide?', a:'Residential, nursing, dementia, respite, and palliative care with personalised plans.', cat:'Care'},
      {id:uid(), q:'How are families involved?', a:'Family-centred approach with care planning meetings and regular communication.', cat:'Family'}
    ],
    users:[
      {id:uid(), name:'Site Administrator', email:'admin@bellavista.co.uk', role:'Admin'},
      {id:uid(), name:'Content Editor', email:'editor@bellavista.co.uk', role:'Editor'}
    ]
  };
  save(seeded);return seeded;
}

let state = load();

// ---------- Navigation ----------
$$('aside .nav button').forEach(btn=>btn.addEventListener('click',()=>{
  $$('aside .nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const view = btn.dataset.view;
  $$('main [data-section]').forEach(sec=>sec.hidden = sec.dataset.section !== view);
}));

// ---------- Global search (filters current table if present) ----------
$('#globalSearch').addEventListener('input', e=>{
  const term = e.target.value.toLowerCase();
  const sec = $$('main [data-section]:not([hidden])')[0];
  if(!sec) return;
  const input = sec.querySelector('input[placeholder^="Search"]');
  if(input){ input.value = term; input.dispatchEvent(new Event('input')); }
});

// ---------- Homes: Add ----------
$('#btnAddHome').addEventListener('click',()=>{
  const name=$('#homeName').value.trim();
  const location=$('#homeLocation').value.trim();
  const image=$('#homeImage').value.trim();
  const desc=$('#homeDesc').value.trim();
  const badge=$('#homeBadge').value;
  const featured=$('#homeFeatured').checked;
  if(!name||!location||!image||!desc){ showToast('Please fill all required fields.'); return; }
  state.homes.push({id:uid(),name,location,image,desc,badge,featured});
  save(state); showToast('Home added.');
  ['#homeName','#homeLocation','#homeImage','#homeDesc'].forEach(sel=>$(sel).value='');
  $('#homeBadge').value=''; $('#homeFeatured').checked=false;
  renderHomes();
});

// ---------- Homes: Table / Edit / Delete ----------
const homesWrap = $('#homesTableWrap');
function renderHomes(filter=''){
  const rows = state.homes.filter(h=>Object.values(h).join(' ').toLowerCase().includes(filter.toLowerCase()))
    .map(h=>`<tr data-id="${h.id}">
      <td><strong>${h.name}</strong><div class="muted">${h.location}</div></td>
      <td><div class="row" style="align-items:center;gap:8px"><img src="${h.image}" alt="" style="width:68px;height:48px;object-fit:cover;border-radius:8px;border:1px solid #eee"/>${h.badge?`<span class='tag warn'>${h.badge}</span>`:''}${h.featured?`<span class='tag success'><i class='fa-solid fa-star'></i> Featured</span>`:''}</div></td>
      <td>${h.desc}</td>
      <td class="right">
        <button class="btn ghost small" data-action="edit"><i class="fa-solid fa-pen"></i></button>
        <button class="btn warn small" data-action="delete"><i class="fa-solid fa-trash"></i></button>
      </td>
    </tr>`).join('');
  homesWrap.innerHTML = state.homes.length? `
    <table>
      <thead><tr><th>Name</th><th>Media & Tags</th><th>Description</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>` : `<div class="empty">No homes yet. Click <b>New</b> to create one.</div>`;
}
$('#homeSearch').addEventListener('input', e=>renderHomes(e.target.value));
$('#btnNewHome').addEventListener('click', ()=>{$('[data-view="add-home"]').click();});
homesWrap.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const tr = e.target.closest('tr'); const id = tr?.dataset.id; const home = state.homes.find(h=>h.id===id);
  if(btn.dataset.action==='delete'){
    if(confirmBox('Delete this home?')){ state.homes=state.homes.filter(h=>h.id!==id); save(state); renderHomes(); showToast('Home deleted.'); }
  }
  if(btn.dataset.action==='edit'){
    openEdit('Edit Home', renderHomeForm(home), (values)=>{
      Object.assign(home, values); save(state); renderHomes(); showToast('Home updated.');
    });
  }
});
function renderHomeForm(h={}){
  return `<div class="grid cols-2">
    <div class="field"><label>Name</label><input data-k="name" value="${h.name||''}"/></div>
    <div class="field"><label>Location</label><input data-k="location" value="${h.location||''}"/></div>
    <div class="field"><label>Image URL</label><input data-k="image" type="url" value="${h.image||''}"/></div>
    <div class="field"><label>Badge</label><select data-k="badge"><option value="" ${!h.badge?'selected':''}>None</option><option ${h.badge==='Featured'?'selected':''}>Featured</option><option ${h.badge==='New'?'selected':''}>New</option><option ${h.badge==='Awarded'?'selected':''}>Awarded</option></select></div>
    <div class="field" style="grid-column:1/-1"><label>Description</label><textarea data-k="desc">${h.desc||''}</textarea></div>
    <label style="display:flex;align-items:center;gap:8px"><input data-k="featured" type="checkbox" ${h.featured?'checked':''}/> Featured</label>
  </div>`;
}

// ---------- News: Add ----------
$('#btnAddNews').addEventListener('click',()=>{
  const title=$('#newsTitle').value.trim();
  const date=$('#newsDate').value; const category=$('#newsCategory').value; const image=$('#newsImage').value.trim();
  const summary=$('#newsSummary').value.trim(); const body=$('#newsBody').value.trim();
  if(!title||!date||!category||!image||!summary){ showToast('Please complete all required fields.'); return; }
  state.news.unshift({id:uid(), title, date, category, image, summary, body}); save(state);
  showToast('News item published.'); ['#newsTitle','#newsImage','#newsSummary','#newsBody'].forEach(s=>$(s).value=''); $('#newsDate').value='';
  renderNews();
});

// ---------- News: Table / Edit / Delete ----------
const newsWrap = $('#newsTableWrap');
function renderNews(filter=''){
  const rows = state.news.filter(n=>Object.values(n).join(' ').toLowerCase().includes(filter.toLowerCase()))
    .map(n=>`<tr data-id="${n.id}">
      <td><strong>${n.title}</strong><div class="muted">${n.category}</div></td>
      <td><div class="row" style="align-items:center;gap:8px"><img src="${n.image}" style="width:68px;height:48px;object-fit:cover;border-radius:8px;border:1px solid #eee"/> ${n.date}</div></td>
      <td>${n.summary}</td>
      <td class="right">
        <button class="btn ghost small" data-action="edit"><i class="fa-solid fa-pen"></i></button>
        <button class="btn warn small" data-action="delete"><i class="fa-solid fa-trash"></i></button>
      </td>
    </tr>`).join('');
  newsWrap.innerHTML = state.news.length? `
    <table>
      <thead><tr><th>Title</th><th>Media & Date</th><th>Summary</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>` : `<div class="empty">No news yet. Add your first update.</div>`;
}
$('#newsSearch').addEventListener('input', e=>renderNews(e.target.value));
newsWrap.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return; const tr=e.target.closest('tr'); const id=tr?.dataset.id; const item=state.news.find(n=>n.id===id);
  if(btn.dataset.action==='delete'){
    if(confirmBox('Delete this news item?')){ state.news=state.news.filter(n=>n.id!==id); save(state); renderNews(); showToast('News deleted.'); }
  }
  if(btn.dataset.action==='edit'){
    openEdit('Edit News', renderNewsForm(item), (values)=>{ Object.assign(item, values); save(state); renderNews(); showToast('News updated.'); });
  }
});
function renderNewsForm(n={}){
  return `<div class="grid cols-2">
    <div class="field"><label>Title</label><input data-k="title" value="${n.title||''}"/></div>
    <div class="field"><label>Date</label><input data-k="date" type="date" value="${n.date||''}"/></div>
    <div class="field"><label>Category</label><select data-k="category"><option ${n.category==='Activities'?'selected':''}>Activities</option><option ${n.category==='Innovation'?'selected':''}>Innovation</option><option ${n.category==='Award'?'selected':''}>Award</option><option ${n.category==='Announcement'?'selected':''}>Announcement</option></select></div>
    <div class="field"><label>Image URL</label><input data-k="image" type="url" value="${n.image||''}"/></div>
    <div class="field" style="grid-column:1/-1"><label>Summary</label><textarea data-k="summary">${n.summary||''}</textarea></div>
    <div class="field" style="grid-column:1/-1"><label>Body</label><textarea data-k="body">${n.body||''}</textarea></div>
  </div>`;
}

// ---------- FAQs ----------
const faqWrap = $('#faqTableWrap');
$('#btnAddFaq').addEventListener('click',()=>{
  const q=$('#faqQ').value.trim(); const a=$('#faqA').value.trim(); const cat=$('#faqCat').value.trim();
  if(!q||!a){ showToast('Please provide question and answer.'); return; }
  state.faqs.push({id:uid(), q, a, cat}); save(state); showToast('FAQ added.');
  ['#faqQ','#faqA','#faqCat'].forEach(s=>$(s).value=''); renderFaqs();
});
function renderFaqs(filter=''){
  const rows = state.faqs.filter(f=>Object.values(f).join(' ').toLowerCase().includes(filter.toLowerCase()))
    .map(f=>`<tr data-id="${f.id}"><td><strong>${f.q}</strong><div class="muted">${f.cat||'General'}</div></td><td>${f.a}</td><td class="right">
      <button class="btn ghost small" data-action="edit"><i class="fa-solid fa-pen"></i></button>
      <button class="btn warn small" data-action="delete"><i class="fa-solid fa-trash"></i></button>
    </td></tr>`).join('');
  faqWrap.innerHTML = state.faqs.length? `<table><thead><tr><th>Question</th><th>Answer</th><th></th></tr></thead><tbody>${rows}</tbody></table>` : `<div class="empty">No FAQs yet.</div>`;
}
$('#faqSearch').addEventListener('input', e=>renderFaqs(e.target.value));
faqWrap.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return; const tr=e.target.closest('tr'); const id=tr?.dataset.id; const item=state.faqs.find(f=>f.id===id);
  if(btn.dataset.action==='delete'){
    if(confirmBox('Delete this FAQ?')){ state.faqs=state.faqs.filter(f=>f.id!==id); save(state); renderFaqs(); showToast('FAQ deleted.'); }
  }
  if(btn.dataset.action==='edit'){
    openEdit('Edit FAQ', `<div class="grid cols-2"><div class="field"><label>Question</label><input data-k="q" value="${item.q}"/></div><div class="field"><label>Category</label><input data-k="cat" value="${item.cat||''}"/></div><div class="field" style="grid-column:1/-1"><label>Answer</label><textarea data-k="a">${item.a}</textarea></div></div>`, (values)=>{ Object.assign(item, values); save(state); renderFaqs(); showToast('FAQ updated.'); });
  }
});

// ---------- Users ----------
const usersWrap = $('#usersTableWrap');
$('#btnAddUser').addEventListener('click',()=>{
  const name=$('#userName').value.trim(); const email=$('#userEmail').value.trim(); const role=$('#userRole').value;
  if(!name||!email){ showToast('Name and email are required.'); return; }
  state.users.push({id:uid(), name, email, role}); save(state); showToast('User added.');
  ['#userName','#userEmail'].forEach(s=>$(s).value=''); $('#userRole').value='Editor'; renderUsers();
});
function renderUsers(filter=''){
  const rows = state.users.filter(u=>Object.values(u).join(' ').toLowerCase().includes(filter.toLowerCase()))
    .map(u=>`<tr data-id="${u.id}"><td><strong>${u.name}</strong><div class="muted">${u.email}</div></td><td><span class="tag">${u.role}</span></td><td class="right">
      <button class="btn ghost small" data-action="edit"><i class="fa-solid fa-pen"></i></button>
      <button class="btn warn small" data-action="delete"><i class="fa-solid fa-user-xmark"></i></button>
      </td></tr>`).join('');
  usersWrap.innerHTML = state.users.length? `<table><thead><tr><th>User</th><th>Role</th><th></th></tr></thead><tbody>${rows}</tbody></table>` : `<div class="empty">No users yet.</div>`;
}
$('#userSearch').addEventListener('input', e=>renderUsers(e.target.value));
usersWrap.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return; const tr=e.target.closest('tr'); const id=tr?.dataset.id; const item=state.users.find(u=>u.id===id);
  if(btn.dataset.action==='delete'){
    if(confirmBox('Remove this user?')){ state.users=state.users.filter(u=>u.id!==id); save(state); renderUsers(); showToast('User removed.'); }
  }
  if(btn.dataset.action==='edit'){
    openEdit('Edit User', `<div class='grid cols-3'><div class='field'><label>Name</label><input data-k='name' value='${item.name}'/></div><div class='field'><label>Email</label><input data-k='email' type='email' value='${item.email}'/></div><div class='field'><label>Role</label><select data-k='role'><option ${item.role==='Admin'?'selected':''}>Admin</option><option ${item.role==='Editor'?'selected':''}>Editor</option><option ${item.role==='Viewer'?'selected':''}>Viewer</option></select></div></div>`, (values)=>{ Object.assign(item, values); save(state); renderUsers(); showToast('User updated.'); });
  }
});

// ---------- Modal / Edit plumbing ----------
let editCallback = null;
function openEdit(title, innerHtml, onSave){
  $('#editTitle').textContent = title; $('#editBody').innerHTML = innerHtml; $('#editModal').classList.add('active'); editCallback = ()=>{
    const data = {}; $$('#editBody [data-k]').forEach(el=>{ const k=el.dataset.k; if(el.type==='checkbox'){ data[k] = el.checked; } else { data[k] = el.value; } });
    onSave(data); closeEdit();
  };
}
function closeEdit(){ $('#editModal').classList.remove('active'); $('#editBody').innerHTML=''; editCallback=null; }
$('#closeModal').onclick = closeEdit; $('#cancelEdit').onclick = closeEdit; $('#saveEdit').onclick = ()=> editCallback && editCallback();

// ---------- Reset ----------
$('#btnReset').addEventListener('click',()=>{ if(confirmBox('Reset to demo data? This will clear all stored data.')){ localStorage.clear(); state = seed(); renderAll(); showToast('Demo data loaded and localStorage cleared.'); }});

// ---------- Schedule Tours ----------
const toursWrap = $('#toursTableWrap');
function renderTours(filter='', locationFilter=''){
  const tours = [
    ...JSON.parse(localStorage.getItem('cardiff-visits') || '[]').map(t => ({...t, location: 'cardiff'})),
    ...JSON.parse(localStorage.getItem('barry-visits') || '[]').map(t => ({...t, location: 'barry'})),
    ...JSON.parse(localStorage.getItem('waverley-visits') || '[]').map(t => ({...t, location: 'waverley'})),
    ...JSON.parse(localStorage.getItem('college-fields-visits') || '[]').map(t => ({...t, location: 'college-fields'})),
    ...JSON.parse(localStorage.getItem('tourBookings') || '[]')
  ];
  
  const filtered = tours.filter(t => {
    const matchesSearch = Object.values(t).join(' ').toLowerCase().includes(filter.toLowerCase());
    const matchesLocation = !locationFilter || t.location === locationFilter;
    return matchesSearch && matchesLocation;
  });
  
  const rows = filtered.map(t => `<tr data-id="${t.timestamp}">
    <td><strong>${t.firstName} ${t.lastName}</strong><div class="muted">${t.email}</div></td>
    <td>${t.id || 'BV' + t.timestamp.slice(-6)}</td>
    <td>${t.location.charAt(0).toUpperCase() + t.location.slice(1)}</td>
    <td>${t.visitDate} ${t.visitTime}</td>
    <td><label style="display:flex;align-items:center;gap:5px"><input type="checkbox" ${t.visited ? 'checked' : ''} onchange="updateVisitStatus('${t.timestamp}', this.checked)"><span style="color:${t.visited ? '#28a745' : '#dc3545'}">${t.visited ? 'Visited' : 'Pending'}</span></label></td>
  </tr>`).join('');
  
  toursWrap.innerHTML = filtered.length ? `
    <div style="margin-bottom:15px">
      <button class="btn success" onclick="exportToursExcel()"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
    </div>
    <table>
      <thead><tr><th>Visitor</th><th>Booking ID</th><th>Location</th><th>Visit Date/Time</th><th>Status</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>` : `<div class="empty">No tour bookings yet.</div>`;
}

$('#tourSearch').addEventListener('input', e => renderTours(e.target.value, $('#tourFilter').value));
$('#tourFilter').addEventListener('change', e => renderTours($('#tourSearch').value, e.target.value));

// ---------- Care Enquiries ----------
const enquiriesWrap = $('#enquiriesTableWrap');
function renderEnquiries(filter='', urgencyFilter='', locationFilter=''){
  const enquiries = [
    ...JSON.parse(localStorage.getItem('enquiries') || '[]'),
    ...JSON.parse(localStorage.getItem('cardiff-enquiries') || '[]').map(e => ({...e, location: 'cardiff'})),
    ...JSON.parse(localStorage.getItem('barry-enquiries') || '[]').map(e => ({...e, location: 'barry'})),
    ...JSON.parse(localStorage.getItem('waverley-enquiries') || '[]').map(e => ({...e, location: 'waverley'})),
    ...JSON.parse(localStorage.getItem('college-fields-enquiries') || '[]').map(e => ({...e, location: 'college-fields'}))
  ];
  const filtered = enquiries.filter(e => {
    const matchesSearch = Object.values(e).join(' ').toLowerCase().includes(filter.toLowerCase());
    const matchesUrgency = !urgencyFilter || e.urgency === urgencyFilter;
    const matchesLocation = !locationFilter || e.location === locationFilter;
    return matchesSearch && matchesUrgency && matchesLocation;
  });
  
  const rows = filtered.map(e => `<tr data-id="${e.timestamp}">
    <td><strong>${e.enquirerName}</strong><div class="muted">${e.email}</div></td>
    <td>${e.careType}<br><small>${(e.location || 'general').charAt(0).toUpperCase() + (e.location || 'general').slice(1)}</small></td>
    <td><span class="tag ${e.urgency === 'immediate' ? 'warn' : 'success'}">${e.urgency}</span></td>
    <td>${new Date(e.timestamp).toLocaleDateString()}</td>
    <td class="right">
      <button class="btn ghost small" data-action="view"><i class="fa-solid fa-eye"></i></button>
      <button class="btn warn small" data-action="delete"><i class="fa-solid fa-trash"></i></button>
    </td>
  </tr>`).join('');
  
  enquiriesWrap.innerHTML = filtered.length ? `
    <table>
      <thead><tr><th>Contact</th><th>Care Type</th><th>Urgency</th><th>Date</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>` : `<div class="empty">No enquiries yet.</div>`;
}

$('#enquirySearch').addEventListener('input', e => renderEnquiries(e.target.value, $('#enquiryFilter').value, $('#enquiryLocationFilter').value));
$('#enquiryFilter').addEventListener('change', e => renderEnquiries($('#enquirySearch').value, e.target.value, $('#enquiryLocationFilter').value));
$('#enquiryLocationFilter').addEventListener('change', e => renderEnquiries($('#enquirySearch').value, $('#enquiryFilter').value, e.target.value));

enquiriesWrap.addEventListener('click', e => {
  const btn = e.target.closest('button'); if(!btn) return;
  const tr = e.target.closest('tr'); const timestamp = tr?.dataset.id;
  const enquiries = JSON.parse(localStorage.getItem('enquiries') || '[]');
  const enquiry = enquiries.find(e => e.timestamp === timestamp);
  
  if(btn.dataset.action === 'delete'){
    if(confirmBox('Delete this enquiry?')){
      const updated = enquiries.filter(e => e.timestamp !== timestamp);
      localStorage.setItem('enquiries', JSON.stringify(updated));
      renderEnquiries(); showToast('Enquiry deleted.');
    }
  }
  
  if(btn.dataset.action === 'view'){
    const details = `
      <div class="grid cols-2">
        <div><strong>Name:</strong> ${enquiry.enquirerName}</div>
        <div><strong>Email:</strong> ${enquiry.email}</div>
        <div><strong>Phone:</strong> ${enquiry.phone}</div>
        <div><strong>Care Type:</strong> ${enquiry.careType}</div>
        <div><strong>Location:</strong> ${enquiry.location}</div>
        <div><strong>Urgency:</strong> ${enquiry.urgency}</div>
        <div style="grid-column:1/-1"><strong>Comments:</strong><br>${enquiry.comments || 'None'}</div>
      </div>`;
    openEdit('Enquiry Details', details, () => {});
  }
});

// ---------- Career Applications ----------
const careerWrap = $('#careerTableWrap');
function renderCareerApplications(filter='', positionFilter=''){
  const applications = JSON.parse(localStorage.getItem('job-applications') || '[]');
  const filtered = applications.filter(a => {
    const matchesSearch = Object.values(a).join(' ').toLowerCase().includes(filter.toLowerCase());
    const matchesPosition = !positionFilter || a.position === positionFilter;
    return matchesSearch && matchesPosition;
  });
  
  const rows = filtered.map(a => `<tr data-id="${a.timestamp}">
    <td><strong>${a.firstName} ${a.lastName}</strong><div class="muted">${a.email}</div></td>
    <td>${a.position}</td>
    <td>${a.location || 'Any'}</td>
    <td>${new Date(a.timestamp).toLocaleDateString()}</td>
    <td class="right">
      <button class="btn ghost small" data-action="view"><i class="fa-solid fa-eye"></i></button>
      <button class="btn warn small" data-action="delete"><i class="fa-solid fa-trash"></i></button>
    </td>
  </tr>`).join('');
  
  careerWrap.innerHTML = filtered.length ? `
    <table>
      <thead><tr><th>Applicant</th><th>Position</th><th>Location</th><th>Applied</th><th></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>` : `<div class="empty">No applications yet.</div>`;
}

$('#careerSearch').addEventListener('input', e => renderCareerApplications(e.target.value, $('#careerFilter').value));
$('#careerFilter').addEventListener('change', e => renderCareerApplications($('#careerSearch').value, e.target.value));

careerWrap.addEventListener('click', e => {
  const btn = e.target.closest('button'); if(!btn) return;
  const tr = e.target.closest('tr'); const timestamp = tr?.dataset.id;
  const applications = JSON.parse(localStorage.getItem('job-applications') || '[]');
  const application = applications.find(a => a.timestamp === timestamp);
  
  if(btn.dataset.action === 'delete'){
    if(confirmBox('Delete this application?')){
      const updated = applications.filter(a => a.timestamp !== timestamp);
      localStorage.setItem('job-applications', JSON.stringify(updated));
      renderCareerApplications(); showToast('Application deleted.');
    }
  }
  
  if(btn.dataset.action === 'view'){
    const details = `
      <div class="grid cols-2">
        <div><strong>Name:</strong> ${application.firstName} ${application.lastName}</div>
        <div><strong>Email:</strong> ${application.email}</div>
        <div><strong>Phone:</strong> ${application.phone}</div>
        <div><strong>Position:</strong> ${application.position}</div>
        <div><strong>Location:</strong> ${application.location || 'Any'}</div>
        <div style="grid-column:1/-1"><strong>Experience:</strong><br>${application.experience}</div>
        <div style="grid-column:1/-1"><strong>Availability:</strong><br>${application.availability || 'Not specified'}</div>
      </div>`;
    openEdit('Application Details', details, () => {});
  }
});

// ---------- Logout function ----------
function logout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('currentUser');
    localStorage.removeItem('users');
    window.location.href = '../../index.html';
  }
}

// File upload handlers
$('#newsImageFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      $('#newsImage').value = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});

$('#homeImageFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      $('#homeImage').value = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});

// Update visit status
function updateVisitStatus(timestamp, visited) {
  // Update in all possible storage locations
  ['cardiff-visits', 'barry-visits', 'waverley-visits', 'college-fields-visits', 'general-visits', 'tourBookings'].forEach(key => {
    const data = JSON.parse(localStorage.getItem(key) || '[]');
    const item = data.find(t => t.timestamp === timestamp);
    if (item) {
      item.visited = visited;
      localStorage.setItem(key, JSON.stringify(data));
    }
  });
  renderTours();
}

// Export tours to Excel
function exportToursExcel() {
  const tours = [
    ...JSON.parse(localStorage.getItem('cardiff-visits') || '[]').map(t => ({...t, location: 'cardiff'})),
    ...JSON.parse(localStorage.getItem('barry-visits') || '[]').map(t => ({...t, location: 'barry'})),
    ...JSON.parse(localStorage.getItem('waverley-visits') || '[]').map(t => ({...t, location: 'waverley'})),
    ...JSON.parse(localStorage.getItem('college-fields-visits') || '[]').map(t => ({...t, location: 'college-fields'})),
    ...JSON.parse(localStorage.getItem('general-visits') || '[]').map(t => ({...t, location: 'general'})),
    ...JSON.parse(localStorage.getItem('tourBookings') || '[]')
  ];
  
  const csvContent = [
    ['Name', 'Email', 'Phone', 'Booking ID', 'Location', 'Visit Date', 'Visit Time', 'Status', 'Booked Date'],
    ...tours.map(t => [
      `${t.firstName || ''} ${t.lastName || ''}`.trim() || t.name || '',
      t.email || '',
      t.phone || '',
      t.id || 'BV' + t.timestamp.slice(-6),
      (t.location || '').charAt(0).toUpperCase() + (t.location || '').slice(1),
      t.visitDate || t.date || '',
      t.visitTime || t.time || '',
      t.visited ? 'Visited' : 'Pending',
      new Date(t.timestamp).toLocaleDateString()
    ])
  ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tour-bookings-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Excel file exported successfully!');
}

// ---------- Initial renders ----------
function renderAll(){ renderHomes(); renderNews(); renderFaqs(); renderUsers(); renderEnquiries(); renderTours(); renderCareerApplications(); }
renderAll();
</script>

</body>
</html>
